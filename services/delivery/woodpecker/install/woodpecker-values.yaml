# ==============================================================================
# Woodpecker CI - Production Configuration
# ==============================================================================
# Документация: https://woodpecker-ci.org/docs/administration/setup
#
# Архитектура:
# - Server (StatefulSet) - веб-интерфейс, API, координация
# - Agent (Deployment) - воркеры для выполнения pipeline задач
# - Database - SQLite (встроенная) или внешняя PostgreSQL/MySQL
#
# Безопасность:
# - Все секреты хранятся в Kubernetes Secret 'woodpecker-secret'
# - НЕ указывайте секреты напрямую в этом файле!
#
# Приоритет переменных окружения в Kubernetes:
# 1. Переменные из секции 'env' (высший приоритет) ← перебивают всё!
# 2. Переменные из 'extraSecretNamesForEnvFrom' (секреты) ← используются если не определены в env
#
# ⚠️ ВАЖНО: Helm chart Woodpecker добавляет дефолтные значения для:
#    - WOODPECKER_ADMIN: "woodpecker,admin"
#    - WOODPECKER_HOST: "https://xxxxxxx"
#
# Чтобы секреты работали, мы явно устанавливаем эти переменные в null в секции env!
# ==============================================================================

# Секреты (создаются отдельно в namespace woodpecker в secret woodpecker-secret):
#
# WOODPECKER_GITHUB: "true"
# WOODPECKER_GITHUB_CLIENT: "YOUR_GITHUB_OAUTH_CLIENT_ID"
# WOODPECKER_GITHUB_SECRET: "YOUR_GITHUB_OAUTH_CLIENT_SECRET"
# WOODPECKER_HOST: "https://example.com"
# WOODPECKER_ADMIN: "YOUR_GITHUB_USERNAME"

# Ingress (настраивается отдельно):
# - См. файл woodpecker-ingress.yaml
# - Устанавливается через: kubectl apply -f woodpecker-ingress.yaml

# ------------------------------------------------------------------------------
# SERVER - Главный компонент Woodpecker
# ------------------------------------------------------------------------------
server:
  # Количество реплик сервера (рекомендуется 1 для SQLite)
  replicas: 1

  # Ресурсы сервера
  resources:
    requests:
      cpu: 100m # Минимум CPU (0.1 ядра)
      memory: 128Mi # Минимум RAM (128 мегабайт)
    limits:
      cpu: 500m # Максимум CPU (0.5 ядра)
      memory: 512Mi # Максимум RAM (512 мегабайт)

  # Хранилище для данных (база SQLite, логи, кеш)
  persistence:
    enabled: true
    storageClass: "ceph-rbd" # ← Ваш StorageClass из Ceph
    size: 5Gi # Размер диска

  # Переменные окружения для сервера
  env:
    # Логирование (уровни: trace, debug, info, warn, error)
    WOODPECKER_LOG_LEVEL: "info"

    # ⚠️ КРИТИЧНО: Явно удаляем дефолтные значения из Helm chart
    # Устанавливаем в null, чтобы переменные НЕ определялись в env
    # и брались ТОЛЬКО из Secret через extraSecretNamesForEnvFrom!
    WOODPECKER_ADMIN: null
    WOODPECKER_HOST: null

    # ℹ️ Остальные переменные (WOODPECKER_GITHUB, и т.д.)
    # также подгружаются из Kubernetes Secret 'woodpecker-secret' (см. ниже)

  # Подключение секретов из Kubernetes Secret
  # Все переменные из Secret автоматически становятся переменными окружения
  extraSecretNamesForEnvFrom:
    - woodpecker-secret # ← Имя Secret с GitHub credentials

  # Ingress - маршрутизация HTTP трафика
  # ⚠️ Ingress вынесен в отдельный файл woodpecker-ingress.yaml
  # Устанавливается отдельно через kubectl apply (см. helm-install.md)
  ingress:
    enabled: false

  # Создать автоматически секрет для подключения Agent к Server
  createAgentSecret: true

# ------------------------------------------------------------------------------
# AGENT - Воркеры для выполнения pipeline задач
# ------------------------------------------------------------------------------
agent:
  # Количество агентов (можно масштабировать)
  # Рекомендация: 2-5 для старта, больше если много параллельных сборок
  replicas: 2

  # Ресурсы агента
  resources:
    requests:
      cpu: 200m # Минимум CPU (0.2 ядра)
      memory: 256Mi # Минимум RAM (256 мегабайт)
    limits:
      cpu: 2000m # Максимум CPU (2 ядра)
      memory: 2Gi # Максимум RAM (2 гигабайта)

  # Переменные окружения для агента
  env:
    # Backend для выполнения задач (kubernetes = поды в кластере)
    WOODPECKER_BACKEND: kubernetes

    # Namespace где создавать поды для pipeline задач
    WOODPECKER_BACKEND_K8S_NAMESPACE: woodpecker

    # Создавать ли отдельный namespace для каждой организации GitHub
    WOODPECKER_BACKEND_K8S_NAMESPACE_PER_ORGANIZATION: false

    # Размер volume для задач (для кеширования, артефактов)
    WOODPECKER_BACKEND_K8S_VOLUME_SIZE: 10G

    # Storage с поддержкой ReadWriteMany (для общего кеша между шагами)
    WOODPECKER_BACKEND_K8S_STORAGE_RWX: true

    # Адрес сервера для подключения агента
    WOODPECKER_SERVER: woodpecker-server:9000

    # Количество попыток переподключения к серверу
    WOODPECKER_CONNECT_RETRY_COUNT: "1"

  # Agent Secret (для подключения к Server)
  # Автоматически создаётся через server.createAgentSecret: true
  # Agent secret подключается автоматически через Helm chart
  extraSecretNamesForEnvFrom: []

  # Хранилище для агента (для кеша, временных файлов)
  persistence:
    enabled: true
    size: 1Gi
    storageClass: "" # Будет использован default StorageClass

  # Service Account с правами создавать поды
  serviceAccount:
    create: true # Создать автоматически
    rbac:
      create: true # Создать Role и RoleBinding

# ------------------------------------------------------------------------------
# DATABASE - База данных
# ------------------------------------------------------------------------------
database:
  # Тип БД:
  # - sqlite: встроенная, простая, хранится на диске server.persistence
  # - postgres: внешняя PostgreSQL (для production с высокой нагрузкой)
  # - mysql: внешняя MySQL
  type: sqlite

# ------------------------------------------------------------------------------
# ДОПОЛНИТЕЛЬНЫЕ НАСТРОЙКИ
# ------------------------------------------------------------------------------

# Переопределение имён ресурсов (обычно не требуется)
nameOverride: ""
fullnameOverride: ""

# Дополнительные Kubernetes объекты (ConfigMap, Secret, и т.д.)
additionalObjects: []
